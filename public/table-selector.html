<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í—ã–±–æ—Ä —Å—Ç–æ–ª–∞ - DEFO</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0A0A0A;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
        }
        
        #tildaFrame {
            width: 100%;
            height: 100vh;
            border: none;
            display: block;
        }
        
        /* Loader */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0A0A0A;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            z-index: 9999;
        }
        
        .loader.hidden {
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #222;
            border-top-color: #D4AF37;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .loader-text {
            color: #D4AF37;
            font-size: 16px;
            font-weight: 600;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Error */
        .error {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1C1C1C;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            z-index: 10000;
            max-width: 90%;
        }
        
        .error.visible {
            display: block;
        }
        
        .error-title {
            color: #F44336;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .error-message {
            color: #888;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .error-btn {
            background: #D4AF37;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="loader" id="loader">
    <div class="spinner"></div>
    <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã —Å—Ç–æ–ª–æ–≤...</div>
</div>

<div class="error" id="error">
    <div class="error-title">‚ö†Ô∏è –û—à–∏–±–∫–∞</div>
    <div class="error-message" id="errorMessage"></div>
    <button class="error-btn" onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
</div>

<iframe id="tildaFrame"></iframe>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
(function() {
    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    let tg = null;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Telegram WebApp
    if (window.Telegram && window.Telegram.WebApp) {
        tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.enableClosingConfirmation();
        console.log('‚úÖ Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    } else {
        console.warn('‚ö†Ô∏è Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)');
        // –°–æ–∑–¥–∞—ë–º mock –æ–±—ä–µ–∫—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        tg = {
            ready: () => {},
            expand: () => {},
            enableClosingConfirmation: () => {},
            CloudStorage: {
                setItem: (key, value, callback) => {
                    console.log('üíæ CloudStorage.setItem:', key, value);
                    localStorage.setItem(key, value);
                    if (callback) callback(null, true);
                }
            },
            sendData: (data) => {
                console.log('üì§ sendData:', data);
            },
            showPopup: (params, callback) => {
                console.log('üí¨ showPopup:', params);
                alert(`${params.title}\n\n${params.message}`);
                if (callback) callback('ok');
            },
            showAlert: (message) => {
                console.log('‚ö†Ô∏è showAlert:', message);
                alert(message);
            },
            BackButton: {
                show: () => console.log('üëà BackButton.show()'),
                onClick: (callback) => {
                    console.log('üëà BackButton.onClick registered');
                    window.backButtonCallback = callback;
                }
            },
            close: () => {
                console.log('üö™ WebApp.close()');
                window.close();
            }
        };
    }
    
    console.log('üöÄ Table Selector –∑–∞–≥—Ä—É–∂–µ–Ω');
    
    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const date = urlParams.get('date');
    const start_time = urlParams.get('start_time');
    const end_time = urlParams.get('end_time');
    const guests = urlParams.get('guests');
    
    console.log('üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', { date, start_time, end_time, guests });
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    if (!date || !start_time || !end_time || !guests) {
        showError('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
        return;
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è Tilda —á–µ—Ä–µ–∑ proxy
    const proxyUrl = `https://defo-booking-api.onrender.com/api/tilda-proxy?` +
        `date=${date}&start_time=${start_time}&end_time=${end_time}&guests=${guests}`;
    
    console.log('üîó –ó–∞–≥—Ä—É–∑–∫–∞ Tilda —á–µ—Ä–µ–∑ proxy:', proxyUrl);
    
    const iframe = document.getElementById('tildaFrame');
    const loader = document.getElementById('loader');
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ iframe
    iframe.onload = function() {
        console.log('‚úÖ Tilda iframe –∑–∞–≥—Ä—É–∂–µ–Ω');
        setTimeout(() => {
            loader.classList.add('hidden');
        }, 1000);
    };
    
    iframe.onerror = function() {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Tilda iframe');
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É —Å—Ç–æ–ª–æ–≤');
    };
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º Tilda —Å—Ç—Ä–∞–Ω–∏—Ü—É
    iframe.src = proxyUrl;
    
    // ============================================
    // –û–ë–†–ê–ë–û–¢–ß–ò–ö POSTMESSAGE –û–¢ TILDA
    // ============================================
    
    window.addEventListener('message', function(event) {
        console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', event);
        console.log('   Origin:', event.origin);
        console.log('   Data:', event.data);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ (Tilda —á–µ—Ä–µ–∑ proxy)
        const allowedOrigins = [
            'https://defo-booking-api.onrender.com',
            'http://defohome.tilda.ws',
            'https://defohome.tilda.ws'
        ];
        
        if (!allowedOrigins.includes(event.origin)) {
            console.warn('‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏—è:', event.origin);
            return;
        }
        
        const data = event.data;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è
        if (data && data.type === 'TABLE_SELECTED') {
            console.log('‚úÖ –°—Ç–æ–ª –≤—ã–±—Ä–∞–Ω!', data);
            console.log('   –°—Ç–æ–ª:', data.table);
            console.log('   –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:', data.booking);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ CloudStorage
            tg.CloudStorage.setItem('selected_table', JSON.stringify(data.table), (error, success) => {
                if (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–æ–ª–∞:', error);
                } else {
                    console.log('‚úÖ –°—Ç–æ–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ CloudStorage');
                }
            });
            
            tg.CloudStorage.setItem('booking_params', JSON.stringify(data.booking), (error, success) => {
                if (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:', error);
                } else {
                    console.log('‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ CloudStorage');
                }
            });
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ Telegram
            tg.sendData(JSON.stringify({
                action: 'table_selected',
                table: data.table,
                booking: data.booking
            }));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            tg.showPopup({
                title: '‚úÖ –°—Ç–æ–ª –≤—ã–±—Ä–∞–Ω',
                message: `–°—Ç–æ–ª ${data.table.table_number} —É—Å–ø–µ—à–Ω–æ –≤—ã–±—Ä–∞–Ω!`,
                buttons: [{ id: 'ok', type: 'ok', text: 'OK' }]
            }, (buttonId) => {
                if (buttonId === 'ok') {
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç–∫—Ä–∞–Ω (—Ñ–æ—Ä–º–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Å—Ç—è)
                    console.log('üîÑ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã—Ö –≥–æ—Å—Ç—è...');
                    
                    // –í–†–ï–ú–ï–ù–ù–û: –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert
                    alert(`–°—Ç–æ–ª ${data.table.table_number} –≤—ã–±—Ä–∞–Ω!\n\n–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: —Ñ–æ—Ä–º–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Å—Ç—è.`);
                    
                    // TODO: –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –∫–æ–≥–¥–∞ —Å–æ–∑–¥–∞—à—å guest-form.html
                    // window.location.href = `/guest-form.html?table_id=${data.table.table_id}&table_number=${data.table.table_number}`;
                }
            });
        }
    });
    
    // ============================================
    // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
    // ============================================
    
    function showError(message) {
        console.error('‚ùå –û—à–∏–±–∫–∞:', message);
        
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('error').classList.add('visible');
        document.getElementById('loader').classList.add('hidden');
        
        tg.showAlert(message);
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
    tg.BackButton.onClick(() => {
        console.log('üîô –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥');
        window.history.back();
    });
    
    tg.BackButton.show();
    
    console.log('‚úÖ Table Selector –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    
})();
</script>

</body>
</html>
